<!DOCTYPE html>
<html lang="lt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valdymo Panelƒó - Mano Startuolis</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            min-height: 100vh;
        }
        .dashboard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px 0;
            margin-bottom: 40px;
        }
        .dashboard-header h1 {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        .dashboard-header .subtitle {
            opacity: 0.9;
            font-size: 16px;
        }
        .btn-logout {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 20px;
            border-radius: 8px;
            font-weight: 500;
        }
        .btn-logout:hover {
            background: rgba(255, 255, 255, 0.3);
            color: white;
        }
        .dashboard-card {
            background: white;
            border-radius: 16px;
            padding: 40px 30px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            text-decoration: none;
            color: inherit;
            display: block;
            height: 100%;
        }
        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            color: inherit;
        }
        .dashboard-card .icon {
            font-size: 64px;
            margin-bottom: 20px;
        }
        .dashboard-card h3 {
            font-size: 20px;
            font-weight: 700;
            color: #333;
            margin-bottom: 8px;
        }
        .dashboard-card p {
            color: #666;
            margin-bottom: 0;
            font-size: 14px;
        }
        .card-expenses {
            border-left: 4px solid #28a745;
        }
        .card-invoices {
            border-left: 4px solid #007bff;
        }
        .card-clients {
            border-left: 4px solid #ffc107;
        }
        .footer-info {
            margin-top: 60px;
            padding: 20px 0;
            text-align: center;
            color: #999;
            font-size: 14px;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .balance-section {
            margin-bottom: 40px;
        }
        .balance-card {
            border-radius: 16px;
            padding: 25px;
            color: white;
            text-align: center;
        }
        .balance-card.positive {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        .balance-card.negative {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        .balance-card.neutral {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .balance-card h2 {
            font-size: 42px;
            font-weight: 700;
            margin: 10px 0;
        }
        .balance-card .label {
            font-size: 14px;
            opacity: 0.9;
        }
        .stat-mini {
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .stat-mini h4 {
            font-size: 24px;
            font-weight: 700;
            margin: 0;
            color: #333;
        }
        .stat-mini p {
            font-size: 12px;
            color: #666;
            margin: 5px 0 0 0;
        }
        .stat-mini.income h4 { color: #28a745; }
        .stat-mini.expense h4 { color: #dc3545; }
        .stat-mini.pending h4 { color: #ffc107; }
    </style>
</head>
<body>
    <!-- Loading overlay (shown until auth is verified) -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="text-center">
            <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">Kraunama...</span>
            </div>
            <p class="text-muted">Tikrinama prisijungimo b≈´sena...</p>
        </div>
    </div>

    <!-- Header -->
    <div class="dashboard-header">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1>Sveiki, <span id="user-name">Vartotojau</span>! üëã</h1>
                    <p class="subtitle" id="user-email"></p>
                </div>
                <button type="button" class="btn btn-logout" id="logout-btn">
                    üö™ Atsijungti
                </button>
            </div>
        </div>
    </div>

    <!-- Dashboard Content -->
    <div class="container">
        <!-- Balance Section -->
        <div class="balance-section">
            <div class="row g-4">
                <div class="col-lg-6">
                    <div class="balance-card neutral" id="balance-card">
                        <div class="label">üí∞ ƒÆMONƒñS BALANSAS</div>
                        <h2 id="total-balance">0.00 ‚Ç¨</h2>
                        <div class="label">(Pajamos - I≈°laidos)</div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="row g-3">
                        <div class="col-6">
                            <div class="stat-mini income">
                                <h4 id="total-income">0 ‚Ç¨</h4>
                                <p>üìà Pajamos (apmokƒótos)</p>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stat-mini expense">
                                <h4 id="total-expenses">0 ‚Ç¨</h4>
                                <p>üìâ I≈°laidos</p>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stat-mini pending">
                                <h4 id="pending-income">0 ‚Ç¨</h4>
                                <p>‚è≥ Laukiama apmokƒójimo</p>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stat-mini">
                                <h4 id="this-month">0 ‚Ç¨</h4>
                                <p>üìÖ ≈†io mƒónesio pajamos</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard Cards -->
        <div class="row g-4">
            <!-- Expenses Card -->
            <div class="col-md-4">
                <a href="/expenses" class="dashboard-card card-expenses">
                    <div class="icon">üßæ</div>
                    <h3>Skenuoti ƒåekius</h3>
                    <p>AI automati≈°kai nuskaito ir kategorizuoja j≈´s≈≥ i≈°laidas</p>
                </a>
            </div>

            <!-- Invoices Card -->
            <div class="col-md-4">
                <a href="/invoices" class="dashboard-card card-invoices">
                    <div class="icon">üìÑ</div>
                    <h3>Ra≈°yti SƒÖskaitas</h3>
                    <p>Kurkite profesionalias sƒÖskaitas fakt≈´ras PDF formatu</p>
                </a>
            </div>

            <!-- Clients Card -->
            <div class="col-md-4">
                <a href="/clients" class="dashboard-card card-clients">
                    <div class="icon">üë•</div>
                    <h3>Klient≈≥ Bazƒó</h3>
                    <p>Valdykite savo klient≈≥ informacijƒÖ vienoje vietoje</p>
                </a>
            </div>
        </div>

        <!-- Quick Stats (placeholder for future) -->
        <div class="row g-4 mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body text-center py-4">
                        <h5 class="text-muted mb-0">üí° Patarimas: Naudokite AI ƒçeki≈≥ skenavimƒÖ, kad sutaupytumƒóte laiko!</h5>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer-info">
            <p>Mano Startuolis ¬© 2024 | Apskaitos Sistema</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- InstantDB integration for Auth and Balance -->
    <script type="module">
        import { init } from 'https://esm.sh/@instantdb/core';

        const APP_ID = 'ad4539a9-2114-44bb-a2f4-524d57448deb';

        let db;
        try {
            db = init({ appId: APP_ID });
            window.db = db;
            console.log("‚úÖ InstantDB (dashboard) connected");
        } catch (e) {
            console.error("InstantDB connection error:", e);
        }

        // Auth check
        if (db) {
            db.subscribeAuth((auth) => {
                // Hide loading overlay
                const loadingOverlay = document.getElementById('loading-overlay');
                if (loadingOverlay) loadingOverlay.style.display = 'none';

                if (!auth.user) {
                    console.log("Not authenticated, redirecting to login");
                    window.location.href = '/';
                } else {
                    window.currentUser = auth.user;
                    console.log("‚úÖ Authenticated as:", auth.user.email);
                    
                    // Display user info
                    const userNameEl = document.getElementById('user-name');
                    const userEmailEl = document.getElementById('user-email');
                    
                    // Extract name from email (before @) or use full email
                    const emailParts = auth.user.email.split('@');
                    const displayName = emailParts[0].charAt(0).toUpperCase() + emailParts[0].slice(1);
                    
                    if (userNameEl) userNameEl.textContent = displayName;
                    if (userEmailEl) userEmailEl.textContent = auth.user.email;
                    
                    // Load balance data
                    loadBalanceData(auth.user.id);
                    
                    // Also save to localStorage for backward compatibility
                    localStorage.setItem('currentUser', auth.user.email);
                }
            });
        } else {
            // Fallback: hide loading and redirect if DB failed
            const loadingOverlay = document.getElementById('loading-overlay');
            if (loadingOverlay) loadingOverlay.style.display = 'none';
            window.location.href = '/';
        }

        // Load balance data from invoices and expenses
        function loadBalanceData(userId) {
            // Load invoices
            db.subscribeQuery({ invoices: { $: { where: { userId: userId } } } }, (resp) => {
                if (resp.error) {
                    console.error("Error loading invoices:", resp.error);
                    return;
                }
                const invoices = resp.data.invoices || [];
                
                // Calculate income (paid invoices only)
                const paidInvoices = invoices.filter(inv => inv.payment_status === 'paid');
                const totalPaidIncome = paidInvoices.reduce((sum, inv) => sum + (inv.total || 0), 0);
                
                // Pending income (unpaid invoices)
                const unpaidInvoices = invoices.filter(inv => inv.payment_status !== 'paid');
                const pendingIncome = unpaidInvoices.reduce((sum, inv) => sum + (inv.total || 0), 0);
                
                // This month income
                const now = new Date();
                const thisMonthInvoices = paidInvoices.filter(inv => {
                    const invDate = new Date(inv.date);
                    return invDate.getMonth() === now.getMonth() && invDate.getFullYear() === now.getFullYear();
                });
                const thisMonthIncome = thisMonthInvoices.reduce((sum, inv) => sum + (inv.total || 0), 0);
                
                // Update UI
                document.getElementById('total-income').textContent = totalPaidIncome.toFixed(2) + ' ‚Ç¨';
                document.getElementById('pending-income').textContent = pendingIncome.toFixed(2) + ' ‚Ç¨';
                document.getElementById('this-month').textContent = thisMonthIncome.toFixed(2) + ' ‚Ç¨';
                
                // Store for balance calculation
                window.totalIncome = totalPaidIncome;
                updateBalance();
            });

            // Load expenses
            db.subscribeQuery({ expenses: { $: { where: { userId: userId } } } }, (resp) => {
                if (resp.error) {
                    console.error("Error loading expenses:", resp.error);
                    return;
                }
                const expenses = resp.data.expenses || [];
                
                // Calculate total expenses
                const totalExpenses = expenses.reduce((sum, exp) => sum + (parseFloat(exp.amount) || 0), 0);
                
                // Update UI
                document.getElementById('total-expenses').textContent = totalExpenses.toFixed(2) + ' ‚Ç¨';
                
                // Store for balance calculation
                window.totalExpenses = totalExpenses;
                updateBalance();
            });
        }

        // Update balance display
        function updateBalance() {
            const income = window.totalIncome || 0;
            const expenses = window.totalExpenses || 0;
            const balance = income - expenses;
            
            const balanceEl = document.getElementById('total-balance');
            const balanceCard = document.getElementById('balance-card');
            
            balanceEl.textContent = balance.toFixed(2) + ' ‚Ç¨';
            
            // Update card color based on balance
            balanceCard.classList.remove('positive', 'negative', 'neutral');
            if (balance > 0) {
                balanceCard.classList.add('positive');
            } else if (balance < 0) {
                balanceCard.classList.add('negative');
            } else {
                balanceCard.classList.add('neutral');
            }
        }

        // Handle logout with InstantDB signOut
        document.getElementById('logout-btn').addEventListener('click', function() {
            if (window.db && window.db.auth) {
                window.db.auth.signOut().then(() => {
                    localStorage.removeItem('currentUser');
                    window.location.href = '/';
                }).catch(err => {
                    console.error("Sign out error:", err);
                    localStorage.removeItem('currentUser');
                    window.location.href = '/';
                });
            } else {
                localStorage.removeItem('currentUser');
                window.location.href = '/';
            }
        });
    </script>
</body>
</html>
