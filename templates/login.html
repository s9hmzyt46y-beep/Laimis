<!DOCTYPE html>
<html lang="lt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prisijungimas - Mano Startuolis</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0;
        }
        .login-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 40px;
            width: 100%;
            max-width: 400px;
        }
        .brand { font-size: 48px; text-align: center; margin-bottom: 20px; }
        h2 { text-align: center; margin-bottom: 30px; color: #333; }
        .debug-box {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 10px;
            margin-top: 20px;
            font-size: 12px;
            font-family: monospace;
            text-align: center;
        }
        .debug-box.success { background: #d4edda; border-color: #c3e6cb; color: #155724; }
        .debug-box.error { background: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; }
        .btn-primary:hover { background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%); }
    </style>
</head>
<body>

<div class="login-card">
    <div class="brand">ğŸš€</div>
    <h2>Prisijungimas</h2>
    
    <!-- Step 1: Email -->
    <div id="step-1">
        <div class="mb-3">
            <label class="form-label">El. paÅ¡to adresas</label>
            <input type="email" id="email-input" class="form-control form-control-lg" placeholder="jusu@email.com">
        </div>
        <button type="button" id="send-btn" class="btn btn-primary btn-lg w-100">
            ğŸ“§ Gauti kodÄ…
        </button>
    </div>
    
    <!-- Step 2: Code -->
    <div id="step-2" style="display: none;">
        <div class="alert alert-success">âœ… Kodas iÅ¡siÅ³stas! Patikrinkite el. paÅ¡tÄ….</div>
        <div class="mb-3">
            <label class="form-label">6 skaitmenÅ³ kodas</label>
            <input type="text" id="code-input" class="form-control form-control-lg text-center" 
                   placeholder="000000" maxlength="6" style="font-size: 24px; letter-spacing: 8px;">
        </div>
        <button type="button" id="verify-btn" class="btn btn-success btn-lg w-100">
            ğŸ” Prisijungti
        </button>
        <button type="button" id="back-btn" class="btn btn-link w-100 mt-2">
            â† GrÄ¯Å¾ti atgal
        </button>
    </div>
    
    <!-- Debug info -->
    <div id="debug-box" class="debug-box">â³ Kraunama...</div>
</div>

<script type="module">
    // Import InstantDB (same URL as expenses.html - works!)
    import { init } from 'https://js.instantdb.com/v0.14.3/api.js';
    
    // Debug helper - shows status on page
    function debug(msg, isError) {
        const box = document.getElementById('debug-box');
        if (box) {
            box.textContent = msg;
            box.className = 'debug-box ' + (isError ? 'error' : 'success');
        }
        console.log('[LOGIN]', msg);
    }
    
    // Variables
    let db = null;
    let userEmail = '';
    
    // DOM Elements
    const emailInput = document.getElementById('email-input');
    const codeInput = document.getElementById('code-input');
    const sendBtn = document.getElementById('send-btn');
    const verifyBtn = document.getElementById('verify-btn');
    const backBtn = document.getElementById('back-btn');
    const step1 = document.getElementById('step-1');
    const step2 = document.getElementById('step-2');
    
    // Initialize InstantDB
    try {
        debug('JungiamÄ—s prie duomenÅ³ bazÄ—s...');
        
        db = init({ 
            appId: 'ad4539a9-2114-44bb-a2f4-524d57448deb' 
        });
        
        debug('âœ… DB prisijungta! Ä®veskite el. paÅ¡tÄ….');
        
        // Check if already logged in
        db.subscribeAuth((auth) => {
            if (auth.user) {
                debug('âœ… Jau prisijungÄ™s: ' + auth.user.email);
                localStorage.setItem('currentUser', auth.user.email);
                setTimeout(() => {
                    window.location.href = '/dashboard';
                }, 500);
            }
        });
        
    } catch (e) {
        debug('âŒ KLAIDA: ' + e.message, true);
        console.error('InstantDB init error:', e);
    }
    
    // Button 1: Send Magic Code
    sendBtn.addEventListener('click', async () => {
        const email = emailInput.value.trim();
        
        if (!email) {
            alert('Ä®veskite el. paÅ¡to adresÄ…!');
            return;
        }
        
        if (!db) {
            alert('DuomenÅ³ bazÄ— nepasiekiama. Atnaujinkite puslapÄ¯.');
            return;
        }
        
        userEmail = email;
        sendBtn.disabled = true;
        sendBtn.innerHTML = 'â³ SiunÄiama...';
        debug('SiunÄiame kodÄ… Ä¯: ' + email);
        
        try {
            await db.auth.sendMagicCode({ email: email });
            
            debug('âœ… Kodas iÅ¡siÅ³stas Ä¯ ' + email);
            step1.style.display = 'none';
            step2.style.display = 'block';
            codeInput.focus();
            
        } catch (err) {
            console.error('Send code error:', err);
            const errorMsg = err.body?.message || err.message || 'NeÅ¾inoma klaida';
            debug('âŒ Klaida: ' + errorMsg, true);
            alert('Nepavyko iÅ¡siÅ³sti kodo: ' + errorMsg);
        } finally {
            sendBtn.disabled = false;
            sendBtn.innerHTML = 'ğŸ“§ Gauti kodÄ…';
        }
    });
    
    // Button 2: Verify Code
    verifyBtn.addEventListener('click', async () => {
        const code = codeInput.value.trim();
        
        if (!code || code.length !== 6) {
            alert('Ä®veskite 6 skaitmenÅ³ kodÄ…!');
            return;
        }
        
        verifyBtn.disabled = true;
        verifyBtn.innerHTML = 'â³ Tikrinama...';
        debug('Tikriname kodÄ…...');
        
        try {
            await db.auth.signInWithMagicCode({ email: userEmail, code: code });
            
            debug('âœ… Prisijungta sÄ—kmingai!');
            localStorage.setItem('currentUser', userEmail);
            
            setTimeout(() => {
                window.location.href = '/dashboard';
            }, 500);
            
        } catch (err) {
            console.error('Verify code error:', err);
            debug('âŒ Blogas kodas', true);
            alert('Blogas kodas! Bandykite dar kartÄ….');
            verifyBtn.disabled = false;
            verifyBtn.innerHTML = 'ğŸ” Prisijungti';
        }
    });
    
    // Button 3: Back
    backBtn.addEventListener('click', () => {
        step1.style.display = 'block';
        step2.style.display = 'none';
        codeInput.value = '';
        debug('âœ… DB prisijungta! Ä®veskite el. paÅ¡tÄ….');
    });
    
    // Enter key handlers
    emailInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendBtn.click();
    });
    
    codeInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') verifyBtn.click();
    });
    
    // Format code input (numbers only)
    codeInput.addEventListener('input', () => {
        codeInput.value = codeInput.value.replace(/[^0-9]/g, '').substring(0, 6);
    });
</script>

</body>
</html>
