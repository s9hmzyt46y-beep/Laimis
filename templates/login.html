<!DOCTYPE html>
<html lang="lt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prisijungimas - Mano Startuolis</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .login-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 40px;
            width: 100%;
            max-width: 400px;
        }
        .brand { font-size: 48px; text-align: center; margin-bottom: 20px; }
        h2 { text-align: center; margin-bottom: 30px; }
        .debug-box {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 10px;
            margin-top: 20px;
            font-size: 12px;
            font-family: monospace;
        }
        .debug-box.success { background: #d4edda; border-color: #c3e6cb; }
        .debug-box.error { background: #f8d7da; border-color: #f5c6cb; }
    </style>
</head>
<body>

<div class="login-card">
    <div class="brand">ğŸš€</div>
    <h2>Prisijungimas</h2>
    
    <!-- Step 1: Email -->
    <div id="step-1">
        <div class="mb-3">
            <label class="form-label">El. paÅ¡to adresas</label>
            <input type="email" id="email-input" class="form-control form-control-lg" placeholder="jusu@email.com">
        </div>
        <button type="button" id="send-btn" class="btn btn-primary btn-lg w-100">
            ğŸ“§ Gauti kodÄ…
        </button>
    </div>
    
    <!-- Step 2: Code -->
    <div id="step-2" style="display: none;">
        <div class="alert alert-success">âœ… Kodas iÅ¡siÅ³stas! Patikrinkite el. paÅ¡tÄ….</div>
        <div class="mb-3">
            <label class="form-label">6 skaitmenÅ³ kodas</label>
            <input type="text" id="code-input" class="form-control form-control-lg text-center" 
                   placeholder="000000" maxlength="6" style="font-size: 24px; letter-spacing: 8px;">
        </div>
        <button type="button" id="verify-btn" class="btn btn-success btn-lg w-100">
            ğŸ” Prisijungti
        </button>
        <button type="button" id="back-btn" class="btn btn-link w-100 mt-2">
            â† GrÄ¯Å¾ti atgal
        </button>
    </div>
    
    <!-- Debug info -->
    <div id="debug-box" class="debug-box">Kraunama...</div>
</div>

<!-- Load InstantDB from CDN -->
<script src="https://js.instantdb.com/v0.14.3/index.global.js"></script>

<script>
    // Debug helper
    function debug(msg, isError) {
        var box = document.getElementById('debug-box');
        box.textContent = msg;
        box.className = 'debug-box ' + (isError ? 'error' : 'success');
        console.log(msg);
    }
    
    // Global variables
    var db = null;
    var userEmail = '';
    
    // Initialize when page loads
    window.onload = function() {
        debug('Puslapis uÅ¾krautas, jungiamÄ—s prie DB...');
        
        try {
            // Check if InstantDB loaded
            if (typeof instantdb === 'undefined') {
                debug('KLAIDA: InstantDB biblioteka neuÅ¾sikrovÄ—!', true);
                return;
            }
            
            // Initialize InstantDB
            db = instantdb.init({ 
                appId: 'ad4539a9-2114-44bb-a2f4-524d57448deb' 
            });
            
            debug('âœ… DB prisijungta! Galite Ä¯vesti el. paÅ¡tÄ….');
            
            // Check if already logged in
            db.subscribeAuth(function(auth) {
                if (auth.user) {
                    debug('Jau prisijungÄ™s: ' + auth.user.email);
                    localStorage.setItem('currentUser', auth.user.email);
                    window.location.href = '/dashboard';
                }
            });
            
        } catch (e) {
            debug('KLAIDA inicijuojant: ' + e.message, true);
            console.error(e);
        }
        
        // Button 1: Send Code
        document.getElementById('send-btn').onclick = function() {
            debug('Mygtukas paspaustas!');
            
            var email = document.getElementById('email-input').value.trim();
            
            if (!email) {
                alert('Ä®veskite el. paÅ¡to adresÄ…!');
                return;
            }
            
            if (!db) {
                alert('DuomenÅ³ bazÄ— nepasiekiama. Atnaujinkite puslapÄ¯.');
                return;
            }
            
            userEmail = email;
            var btn = document.getElementById('send-btn');
            btn.disabled = true;
            btn.innerHTML = 'â³ SiunÄiama...';
            
            debug('SiunÄiame kodÄ… Ä¯: ' + email);
            
            db.auth.sendMagicCode({ email: email })
                .then(function() {
                    debug('âœ… Kodas iÅ¡siÅ³stas Ä¯ ' + email);
                    document.getElementById('step-1').style.display = 'none';
                    document.getElementById('step-2').style.display = 'block';
                    document.getElementById('code-input').focus();
                })
                .catch(function(err) {
                    debug('KLAIDA: ' + (err.body ? err.body.message : err.message), true);
                    alert('Nepavyko iÅ¡siÅ³sti kodo: ' + (err.body ? err.body.message : err.message));
                    btn.disabled = false;
                    btn.innerHTML = 'ğŸ“§ Gauti kodÄ…';
                });
        };
        
        // Button 2: Verify Code
        document.getElementById('verify-btn').onclick = function() {
            var code = document.getElementById('code-input').value.trim();
            
            if (!code || code.length !== 6) {
                alert('Ä®veskite 6 skaitmenÅ³ kodÄ…!');
                return;
            }
            
            var btn = document.getElementById('verify-btn');
            btn.disabled = true;
            btn.innerHTML = 'â³ Tikrinama...';
            
            debug('Tikriname kodÄ…...');
            
            db.auth.signInWithMagicCode({ email: userEmail, code: code })
                .then(function() {
                    debug('âœ… Prisijungta sÄ—kmingai!');
                    localStorage.setItem('currentUser', userEmail);
                    window.location.href = '/dashboard';
                })
                .catch(function(err) {
                    debug('KLAIDA: Blogas kodas', true);
                    alert('Blogas kodas! Bandykite dar kartÄ….');
                    btn.disabled = false;
                    btn.innerHTML = 'ğŸ” Prisijungti';
                });
        };
        
        // Button 3: Back
        document.getElementById('back-btn').onclick = function() {
            document.getElementById('step-1').style.display = 'block';
            document.getElementById('step-2').style.display = 'none';
            document.getElementById('code-input').value = '';
            debug('âœ… DB prisijungta! Galite Ä¯vesti el. paÅ¡tÄ….');
        };
        
        // Enter key handlers
        document.getElementById('email-input').onkeypress = function(e) {
            if (e.key === 'Enter') {
                document.getElementById('send-btn').click();
            }
        };
        
        document.getElementById('code-input').onkeypress = function(e) {
            if (e.key === 'Enter') {
                document.getElementById('verify-btn').click();
            }
        };
        
        // Format code input (numbers only)
        document.getElementById('code-input').oninput = function() {
            this.value = this.value.replace(/[^0-9]/g, '').substring(0, 6);
        };
    };
</script>

</body>
</html>
