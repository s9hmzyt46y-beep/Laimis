<!DOCTYPE html>
<html lang="lt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SÄ…skaitos - Mano Startuolis</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 12px; padding: 20px; text-align: center; }
        .stat-card h3 { font-size: 28px; font-weight: bold; margin: 0; }
        .stat-card p { font-size: 14px; opacity: 0.9; margin: 5px 0 0 0; }
        .stat-card.green { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
        .stat-card.orange { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .stat-card.blue { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .vat-summary { background: #f8f9fa; border-radius: 8px; padding: 15px; }
        .total-row { font-weight: bold; font-size: 1.1em; border-top: 2px solid #dee2e6; padding-top: 10px; margin-top: 10px; }
        .invoice-row { cursor: pointer; transition: background 0.2s; }
        .invoice-row:hover { background: #e3f2fd; }
        .status-paid { background-color: #d4edda; color: #155724; }
        .status-pending { background-color: #fff3cd; color: #856404; }
        .status-overdue { background-color: #f8d7da; color: #721c24; }
        .invoice-title-input { font-size: 1.1em; font-weight: bold; border: 1px dashed #ccc; background: transparent; }
        .invoice-title-input:focus { border: 1px solid #007bff; background: white; }
        .seller-saved-badge { background: #28a745; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4">
        <div class="container">
            <a class="navbar-brand" href="/dashboard">ğŸš€ Mano Startuolis</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNavbar">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="mainNavbar">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item"><a class="nav-link" href="/expenses">IÅ¡laidos</a></li>
                    <li class="nav-item"><a class="nav-link active" href="/invoices">SÄ…skaitos</a></li>
                    <li class="nav-item"><a class="nav-link" href="/clients">Klientai</a></li>
                </ul>
                <div class="d-flex align-items-center">
                    <span class="text-muted me-3" id="navbar-user"></span>
                    <button class="btn btn-outline-secondary btn-sm" onclick="window.signOut()">ğŸšª Atsijungti</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="stat-card">
                    <h3 id="stat-total-count">0</h3>
                    <p>ğŸ“„ Visos sÄ…skaitos</p>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stat-card green">
                    <h3 id="stat-paid-amount">0 â‚¬</h3>
                    <p>âœ… ApmokÄ—ta</p>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stat-card orange">
                    <h3 id="stat-unpaid-amount">0 â‚¬</h3>
                    <p>â³ NeapmokÄ—ta</p>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stat-card blue">
                    <h3 id="stat-this-month">0 â‚¬</h3>
                    <p>ğŸ“… Å Ä¯ mÄ—nesÄ¯</p>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Left: New Invoice Form -->
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">â• Nauja sÄ…skaita</h5>
                        <div>
                            <button type="button" class="btn btn-sm btn-light me-1" onclick="exportToExcel()">ğŸ“Š Excel</button>
                            <button type="button" class="btn btn-sm btn-light" onclick="clearInvoiceForm()">ğŸ”„ IÅ¡valyti</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <form id="invoice-form">
                            <input type="hidden" id="editing-invoice-id" value="">
                            
                            <!-- SÄ…skaitos pavadinimas (redaguojamas) -->
                            <div class="mb-3">
                                <label class="form-label">ğŸ“‹ Dokumento tipas</label>
                                <input type="text" class="form-control invoice-title-input" name="invoice_title" 
                                       value="PVM SÄ„SKAITA FAKTÅªRA" placeholder="PVM SÄ„SKAITA FAKTÅªRA">
                            </div>
                            
                            <!-- PardavÄ—jo duomenys -->
                            <div class="card bg-light mb-3">
                                <div class="card-header py-2 d-flex justify-content-between align-items-center">
                                    <strong>ğŸ¢ PardavÄ—jo duomenys</strong>
                                    <div>
                                        <span id="seller-saved-badge" class="seller-saved-badge" style="display:none;">IÅ¡saugota</span>
                                        <button type="button" class="btn btn-sm btn-success ms-2" onclick="saveSellerData()" title="IÅ¡saugoti duomenis">ğŸ’¾</button>
                                        <button type="button" class="btn btn-sm btn-link" data-bs-toggle="collapse" data-bs-target="#sellerDetails">â–¼</button>
                                    </div>
                                </div>
                                <div class="collapse show" id="sellerDetails">
                                    <div class="card-body py-2">
                                        <div class="row g-2">
                                            <div class="col-md-6">
                                                <input type="text" class="form-control form-control-sm" name="seller_name" placeholder="Ä®monÄ—s pavadinimas">
                                            </div>
                                            <div class="col-md-6">
                                                <input type="text" class="form-control form-control-sm" name="seller_code" placeholder="Ä®monÄ—s kodas">
                                            </div>
                                            <div class="col-md-6">
                                                <input type="text" class="form-control form-control-sm" name="seller_vat" placeholder="PVM mokÄ—tojo kodas">
                                            </div>
                                            <div class="col-md-6">
                                                <input type="text" class="form-control form-control-sm" name="seller_bank" placeholder="Banko sÄ…skaita (IBAN)">
                                            </div>
                                            <div class="col-12">
                                                <input type="text" class="form-control form-control-sm" name="seller_address" placeholder="Adresas">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- PirkÄ—jo ir sÄ…skaitos duomenys -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">ğŸ‘¤ PirkÄ—jas</label>
                                    <select id="clientSelect" class="form-select mb-2">
                                        <option value="">--- Pasirinkti ---</option>
                                    </select>
                                    <input type="text" class="form-control" name="client_name" placeholder="Kliento pavadinimas" required>
                                    <input type="text" class="form-control form-control-sm mt-1" name="client_code" placeholder="Ä®monÄ—s kodas">
                                    <input type="text" class="form-control form-control-sm mt-1" name="client_vat" placeholder="PVM kodas">
                                    <input type="text" class="form-control form-control-sm mt-1" name="client_address" placeholder="Adresas">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">ğŸ“„ SÄ…skaitos Nr.</label>
                                    <div class="input-group mb-2">
                                        <input type="text" class="form-control" name="invoice_series" placeholder="SF" style="max-width:80px;">
                                        <span class="input-group-text">-</span>
                                        <input type="number" class="form-control" name="invoice_number" placeholder="001" min="1" required>
                                    </div>
                                    <label class="form-label">ğŸ“… IÅ¡raÅ¡ymo data</label>
                                    <input type="date" class="form-control mb-2" name="date" required>
                                    <label class="form-label">â° ApmokÄ—jimo terminas</label>
                                    <input type="date" class="form-control" name="due_date">
                                </div>
                            </div>

                            <!-- Items Table -->
                            <div class="table-responsive mb-3">
                                <table class="table table-sm table-bordered" id="items-table">
                                    <thead class="table-light">
                                        <tr>
                                            <th>ApraÅ¡ymas</th>
                                            <th style="width:60px;">Kiek.</th>
                                            <th style="width:80px;">Kaina</th>
                                            <th style="width:50px;">PVM%</th>
                                            <th style="width:80px;">Suma</th>
                                            <th style="width:40px;">ğŸ—‘ï¸</th>
                                        </tr>
                                    </thead>
                                    <tbody id="items-body"></tbody>
                                </table>
                            </div>

                            <button type="button" class="btn btn-outline-primary btn-sm mb-3" id="add-item-btn">+ EilutÄ—</button>

                            <!-- Totals -->
                            <div class="vat-summary">
                                <div class="row">
                                    <div class="col-7">Be PVM:</div>
                                    <div class="col-5 text-end"><span id="subtotal">0.00</span> â‚¬</div>
                                </div>
                                <div class="row">
                                    <div class="col-7">PVM:</div>
                                    <div class="col-5 text-end"><span id="vat-total">0.00</span> â‚¬</div>
                                </div>
                                <div class="row total-row">
                                    <div class="col-7">VISO:</div>
                                    <div class="col-5 text-end"><span id="invoice-total">0.00</span> â‚¬</div>
                                </div>
                            </div>

                            <div class="d-flex gap-2 mt-3">
                                <button type="button" class="btn btn-success flex-grow-1" id="save-invoice-btn">
                                    ğŸ’¾ IÅ¡saugoti sÄ…skaitÄ…
                                </button>
                                <button type="button" class="btn btn-primary" id="generate-pdf-btn">
                                    ğŸ“„ PDF
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Right: Saved Invoices List -->
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">ğŸ“‹ IÅ¡saugotos sÄ…skaitos</h5>
                        <button class="btn btn-sm btn-outline-light" onclick="exportAllInvoicesToExcel()">ğŸ“Š Eksportuoti Excel</button>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Nr.</th>
                                        <th>Klientas</th>
                                        <th>Data</th>
                                        <th class="text-end">Suma</th>
                                        <th class="text-center">Statusas</th>
                                        <th class="text-center">Veiksmai</th>
                                    </tr>
                                </thead>
                                <tbody id="invoices-list">
                                    <tr>
                                        <td colspan="6" class="text-center text-muted py-4">
                                            â³ Kraunama...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- View Invoice Modal -->
    <div class="modal fade" id="viewInvoiceModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">ğŸ“„ <span id="modal-invoice-title">SÄ…skaita</span> <span id="modal-invoice-number"></span></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modal-invoice-body">
                    <!-- Content loaded dynamically -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">UÅ¾daryti</button>
                    <button type="button" class="btn btn-primary" id="modal-download-pdf">ğŸ“„ AtsisiÅ³sti PDF</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Status Modal -->
    <div class="modal fade" id="paymentModal" tabindex="-1">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">ğŸ’° ApmokÄ—jimo statusas</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="payment-invoice-id">
                    <div class="mb-3">
                        <label class="form-label">Statusas</label>
                        <select class="form-select" id="payment-status">
                            <option value="unpaid">â³ NeapmokÄ—ta</option>
                            <option value="paid">âœ… ApmokÄ—ta</option>
                        </select>
                    </div>
                    <div class="mb-3" id="payment-date-group" style="display:none;">
                        <label class="form-label">ApmokÄ—jimo data</label>
                        <input type="date" class="form-control" id="payment-date">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">AtÅ¡aukti</button>
                    <button type="button" class="btn btn-success" onclick="savePaymentStatus()">ğŸ’¾ IÅ¡saugoti</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- SheetJS for Excel export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <script>
        // DOM Elements
        const itemsBody = document.getElementById('items-body');
        const subtotalEl = document.getElementById('subtotal');
        const vatTotalEl = document.getElementById('vat-total');
        const invoiceTotalEl = document.getElementById('invoice-total');

        // Load seller data from localStorage on page load
        function loadSellerData() {
            const saved = localStorage.getItem('sellerData');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    const form = document.getElementById('invoice-form');
                    if (data.seller_name) form.querySelector('[name="seller_name"]').value = data.seller_name;
                    if (data.seller_code) form.querySelector('[name="seller_code"]').value = data.seller_code;
                    if (data.seller_vat) form.querySelector('[name="seller_vat"]').value = data.seller_vat;
                    if (data.seller_bank) form.querySelector('[name="seller_bank"]').value = data.seller_bank;
                    if (data.seller_address) form.querySelector('[name="seller_address"]').value = data.seller_address;
                    document.getElementById('seller-saved-badge').style.display = 'inline';
                    console.log("âœ… PardavÄ—jo duomenys uÅ¾krauti");
                } catch(e) {
                    console.error("Error loading seller data:", e);
                }
            }
            
            // Load invoice series
            const series = localStorage.getItem('invoiceSeries');
            if (series) {
                document.querySelector('[name="invoice_series"]').value = series;
            } else {
                document.querySelector('[name="invoice_series"]').value = 'SF';
            }
        }

        // Save seller data to localStorage
        window.saveSellerData = function() {
            const form = document.getElementById('invoice-form');
            const data = {
                seller_name: form.querySelector('[name="seller_name"]').value.trim(),
                seller_code: form.querySelector('[name="seller_code"]').value.trim(),
                seller_vat: form.querySelector('[name="seller_vat"]').value.trim(),
                seller_bank: form.querySelector('[name="seller_bank"]').value.trim(),
                seller_address: form.querySelector('[name="seller_address"]').value.trim()
            };
            localStorage.setItem('sellerData', JSON.stringify(data));
            
            // Also save series
            const series = form.querySelector('[name="invoice_series"]').value.trim() || 'SF';
            localStorage.setItem('invoiceSeries', series);
            
            document.getElementById('seller-saved-badge').style.display = 'inline';
            alert('âœ… PardavÄ—jo duomenys iÅ¡saugoti!');
        };

        // Set today's date and default due date (14 days)
        function setDefaultDates() {
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            document.querySelector('[name="date"]').value = todayStr;
            
            // Due date: 14 days from now
            const dueDate = new Date(today);
            dueDate.setDate(dueDate.getDate() + 14);
            document.querySelector('[name="due_date"]').value = dueDate.toISOString().split('T')[0];
        }

        // Recalculate totals
        function recalcTotals() {
            let subtotal = 0, vatTotal = 0, total = 0;
            itemsBody.querySelectorAll('tr').forEach(row => {
                const qty = parseFloat(row.querySelector('[name="item_qty"]')?.value) || 0;
                const net = parseFloat(row.querySelector('[name="item_net"]')?.value) || 0;
                const vatRate = parseFloat(row.querySelector('[name="item_vat_rate"]')?.value) || 21;
                const lineNet = qty * net;
                const lineVat = lineNet * (vatRate / 100);
                subtotal += lineNet;
                vatTotal += lineVat;
                total += lineNet + lineVat;
                
                const totalInput = row.querySelector('[name="item_total"]');
                if (totalInput) totalInput.value = (lineNet + lineVat).toFixed(2);
            });
            subtotalEl.textContent = subtotal.toFixed(2);
            vatTotalEl.textContent = vatTotal.toFixed(2);
            invoiceTotalEl.textContent = total.toFixed(2);
        }

        // Add item row
        function addItem(data = {}) {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><input type="text" class="form-control form-control-sm" name="item_description" value="${data.description || ''}" required></td>
                <td><input type="number" class="form-control form-control-sm" name="item_qty" min="1" value="${data.qty || 1}" required></td>
                <td><input type="number" class="form-control form-control-sm" name="item_net" min="0" step="0.01" value="${data.net || '0.00'}" required></td>
                <td><input type="number" class="form-control form-control-sm" name="item_vat_rate" min="0" max="100" value="${data.vatRate || 21}" required></td>
                <td><input type="number" class="form-control form-control-sm" name="item_total" value="${data.total || '0.00'}" readonly style="background:#e9ecef;"></td>
                <td class="text-center"><button type="button" class="btn btn-sm btn-outline-danger remove-btn">âœ•</button></td>
            `;
            itemsBody.appendChild(row);
            
            row.querySelectorAll('input').forEach(input => {
                if (input.name !== 'item_total') {
                    input.addEventListener('input', recalcTotals);
                }
            });
            row.querySelector('.remove-btn').addEventListener('click', () => { row.remove(); recalcTotals(); });
            recalcTotals();
        }

        document.getElementById('add-item-btn').addEventListener('click', () => addItem());

        // Clear form
        window.clearInvoiceForm = function() {
            document.getElementById('invoice-form').reset();
            document.getElementById('editing-invoice-id').value = '';
            itemsBody.innerHTML = '';
            addItem();
            document.getElementById('save-invoice-btn').innerHTML = 'ğŸ’¾ IÅ¡saugoti sÄ…skaitÄ…';
            
            // Restore seller data and defaults
            loadSellerData();
            setDefaultDates();
            
            // Set next invoice number
            if (window.allInvoices && window.allInvoices.length > 0) {
                const maxNum = Math.max(...window.allInvoices.map(inv => parseInt(inv.invoice_num) || 0));
                document.querySelector('[name="invoice_number"]').value = maxNum + 1;
            } else {
                document.querySelector('[name="invoice_number"]').value = 1;
            }
        };

        // Load invoice into form for editing
        window.loadInvoiceToForm = function(invoice) {
            const form = document.getElementById('invoice-form');
            
            // Document title
            form.querySelector('[name="invoice_title"]').value = invoice.invoice_title || 'PVM SÄ„SKAITA FAKTÅªRA';
            
            // PardavÄ—jo duomenys
            if (form.querySelector('[name="seller_name"]')) form.querySelector('[name="seller_name"]').value = invoice.seller_name || '';
            if (form.querySelector('[name="seller_code"]')) form.querySelector('[name="seller_code"]').value = invoice.seller_code || '';
            if (form.querySelector('[name="seller_vat"]')) form.querySelector('[name="seller_vat"]').value = invoice.seller_vat || '';
            if (form.querySelector('[name="seller_bank"]')) form.querySelector('[name="seller_bank"]').value = invoice.seller_bank || '';
            if (form.querySelector('[name="seller_address"]')) form.querySelector('[name="seller_address"]').value = invoice.seller_address || '';
            
            // PirkÄ—jo duomenys
            form.querySelector('[name="client_name"]').value = invoice.client_name || '';
            if (form.querySelector('[name="client_code"]')) form.querySelector('[name="client_code"]').value = invoice.client_code || '';
            if (form.querySelector('[name="client_vat"]')) form.querySelector('[name="client_vat"]').value = invoice.client_vat || '';
            if (form.querySelector('[name="client_address"]')) form.querySelector('[name="client_address"]').value = invoice.client_address || '';
            
            // SÄ…skaitos duomenys
            form.querySelector('[name="invoice_series"]').value = invoice.invoice_series || 'SF';
            form.querySelector('[name="invoice_number"]').value = invoice.invoice_num || '';
            form.querySelector('[name="date"]').value = invoice.date || '';
            form.querySelector('[name="due_date"]').value = invoice.due_date || '';
            document.getElementById('editing-invoice-id').value = invoice.id || '';
            
            itemsBody.innerHTML = '';
            const items = invoice.items || [];
            if (items.length === 0) {
                addItem();
            } else {
                items.forEach(item => addItem(item));
            }
            
            document.getElementById('save-invoice-btn').innerHTML = 'ğŸ’¾ Atnaujinti sÄ…skaitÄ…';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        // Generate PDF
        window.generatePDF = async function(invoiceData = null) {
            const data = invoiceData || window.getInvoiceData();
            
            if (!data.client_name || !data.invoice_number || !data.date) {
                alert('UÅ¾pildykite visus laukus!');
                return;
            }
            if (data.items.length === 0) {
                alert('PridÄ—kite bent vienÄ… eilutÄ™!');
                return;
            }

            const btn = document.getElementById('generate-pdf-btn');
            btn.disabled = true;
            btn.innerHTML = 'â³...';

            try {
                const response = await fetch('/api/generate-pdf', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || 'PDF klaida');
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${data.invoice_series}-${data.invoice_number}.pdf`;
                a.click();
                window.URL.revokeObjectURL(url);
            } catch (error) {
                alert('Klaida: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'ğŸ“„ PDF';
            }
        };

        document.getElementById('generate-pdf-btn').addEventListener('click', () => window.generatePDF());

        // Payment status modal handling
        document.getElementById('payment-status').addEventListener('change', function() {
            const dateGroup = document.getElementById('payment-date-group');
            if (this.value === 'paid') {
                dateGroup.style.display = 'block';
                document.getElementById('payment-date').value = new Date().toISOString().split('T')[0];
            } else {
                dateGroup.style.display = 'none';
            }
        });

        window.showPaymentModal = function(invoiceId) {
            const invoice = window.allInvoices?.find(i => i.id === invoiceId);
            if (!invoice) return;
            
            document.getElementById('payment-invoice-id').value = invoiceId;
            document.getElementById('payment-status').value = invoice.payment_status || 'unpaid';
            
            const dateGroup = document.getElementById('payment-date-group');
            if (invoice.payment_status === 'paid') {
                dateGroup.style.display = 'block';
                document.getElementById('payment-date').value = invoice.payment_date || '';
            } else {
                dateGroup.style.display = 'none';
            }
            
            new bootstrap.Modal(document.getElementById('paymentModal')).show();
        };

        window.savePaymentStatus = async function() {
            const invoiceId = document.getElementById('payment-invoice-id').value;
            const status = document.getElementById('payment-status').value;
            const paymentDate = status === 'paid' ? document.getElementById('payment-date').value : null;
            
            try {
                await window.db.transact([
                    window.tx.invoices[invoiceId].update({
                        payment_status: status,
                        payment_date: paymentDate
                    })
                ]);
                bootstrap.Modal.getInstance(document.getElementById('paymentModal')).hide();
                alert('âœ… Statusas atnaujintas!');
            } catch(e) {
                alert('Klaida: ' + e.message);
            }
        };

        // Excel export for single invoice
        window.exportToExcel = function() {
            const data = window.getInvoiceData();
            if (!data.client_name) {
                alert('UÅ¾pildykite sÄ…skaitos duomenis!');
                return;
            }
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            
            // Invoice info sheet
            const infoData = [
                ['SÄ…skaitos informacija'],
                ['Tipas', data.invoice_title],
                ['Numeris', `${data.invoice_series}-${data.invoice_number}`],
                ['Data', data.date],
                ['ApmokÄ—jimo terminas', data.due_date],
                [''],
                ['PardavÄ—jas'],
                ['Pavadinimas', data.seller_name],
                ['Ä®monÄ—s kodas', data.seller_code],
                ['PVM kodas', data.seller_vat],
                ['IBAN', data.seller_bank],
                ['Adresas', data.seller_address],
                [''],
                ['PirkÄ—jas'],
                ['Pavadinimas', data.client_name],
                ['Ä®monÄ—s kodas', data.client_code],
                ['PVM kodas', data.client_vat],
                ['Adresas', data.client_address],
            ];
            const ws1 = XLSX.utils.aoa_to_sheet(infoData);
            XLSX.utils.book_append_sheet(wb, ws1, 'Informacija');
            
            // Items sheet
            const itemsData = [
                ['ApraÅ¡ymas', 'Kiekis', 'Kaina be PVM', 'PVM %', 'PVM suma', 'Suma su PVM'],
                ...data.items.map(item => [
                    item.description,
                    item.qty,
                    item.net,
                    item.vatRate,
                    item.vatAmount,
                    item.total
                ]),
                [],
                ['', '', '', '', 'Be PVM:', data.subtotal],
                ['', '', '', '', 'PVM:', data.vat_total],
                ['', '', '', '', 'VISO:', data.total]
            ];
            const ws2 = XLSX.utils.aoa_to_sheet(itemsData);
            XLSX.utils.book_append_sheet(wb, ws2, 'PrekÄ—s');
            
            // Download
            XLSX.writeFile(wb, `${data.invoice_series}-${data.invoice_number}.xlsx`);
        };

        // Excel export for all invoices
        window.exportAllInvoicesToExcel = function() {
            if (!window.allInvoices || window.allInvoices.length === 0) {
                alert('NÄ—ra sÄ…skaitÅ³ eksportui!');
                return;
            }
            
            const wb = XLSX.utils.book_new();
            
            // Summary sheet
            const summaryData = [
                ['SÄ…skaitÅ³ sÄ…raÅ¡as'],
                ['Eksportuota', new Date().toLocaleString('lt-LT')],
                [''],
                ['Nr.', 'Klientas', 'Data', 'Terminas', 'Suma be PVM', 'PVM', 'Suma su PVM', 'Statusas', 'ApmokÄ—ta']
            ];
            
            window.allInvoices.forEach(inv => {
                summaryData.push([
                    `${inv.invoice_series || 'SF'}-${inv.invoice_num || ''}`,
                    inv.client_name,
                    inv.date,
                    inv.due_date || '',
                    inv.subtotal || 0,
                    inv.vat_total || 0,
                    inv.total || 0,
                    inv.payment_status === 'paid' ? 'ApmokÄ—ta' : 'NeapmokÄ—ta',
                    inv.payment_date || ''
                ]);
            });
            
            // Add totals row
            const totalAmount = window.allInvoices.reduce((sum, inv) => sum + (inv.total || 0), 0);
            const paidAmount = window.allInvoices.filter(i => i.payment_status === 'paid').reduce((sum, inv) => sum + (inv.total || 0), 0);
            summaryData.push([]);
            summaryData.push(['', '', '', 'VISO:', '', '', totalAmount.toFixed(2)]);
            summaryData.push(['', '', '', 'ApmokÄ—ta:', '', '', paidAmount.toFixed(2)]);
            summaryData.push(['', '', '', 'NeapmokÄ—ta:', '', '', (totalAmount - paidAmount).toFixed(2)]);
            
            const ws = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, ws, 'SÄ…skaitos');
            
            // Download
            XLSX.writeFile(wb, `Saskaitos_${new Date().toISOString().split('T')[0]}.xlsx`);
        };

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadSellerData();
            setDefaultDates();
            addItem(); // Initial row
        });
    </script>

    <!-- InstantDB integration -->
    <script type="module">
        import { init, tx, id } from 'https://esm.sh/@instantdb/core';

        const APP_ID = 'ad4539a9-2114-44bb-a2f4-524d57448deb';
        let db, currentUserId;

        try {
            db = init({ appId: APP_ID });
            window.db = db;
            window.tx = tx;
            window.id = id;
            console.log("âœ… InstantDB connected");
        } catch (e) {
            console.error("DB error:", e);
        }

        if (db) {
            db.subscribeAuth((auth) => {
                if (!auth.user) {
                    window.location.href = '/';
                } else {
                    window.currentUser = auth.user;
                    currentUserId = auth.user.id;
                    document.getElementById('navbar-user').textContent = 'ğŸ‘¤ ' + auth.user.email;
                    loadClients(auth.user.id);
                    loadInvoices(auth.user.id);
                }
            });
        }

        // Load clients for dropdown
        function loadClients(userId) {
            db.subscribeQuery({ clients: { $: { where: { userId: userId } } } }, (resp) => {
                if (resp.error) return;
                const clients = resp.data.clients || [];
                const select = document.getElementById('clientSelect');
                select.innerHTML = '<option value="">--- Pasirinkti ---</option>';
                clients.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.id;
                    opt.textContent = c.name || '(be pavadinimo)';
                    opt.dataset.code = c.code || '';
                    opt.dataset.vat = c.vat_code || '';
                    opt.dataset.address = c.address || '';
                    select.appendChild(opt);
                });
                select.onchange = () => {
                    const selectedOption = select.options[select.selectedIndex];
                    if (selectedOption.value) {
                        document.querySelector('[name="client_name"]').value = selectedOption.textContent;
                        document.querySelector('[name="client_code"]').value = selectedOption.dataset.code || '';
                        document.querySelector('[name="client_vat"]').value = selectedOption.dataset.vat || '';
                        document.querySelector('[name="client_address"]').value = selectedOption.dataset.address || '';
                    }
                };
                window.allClients = clients;
            });
        }

        // Load invoices
        function loadInvoices(userId) {
            db.subscribeQuery({ invoices: { $: { where: { userId: userId } } } }, (resp) => {
                if (resp.error) {
                    console.error("Load invoices error:", resp.error);
                    return;
                }
                const invoices = resp.data.invoices || [];
                window.allInvoices = invoices;
                renderInvoicesList(invoices);
                updateStatistics(invoices);
                setNextInvoiceNumber(invoices);
            });
        }

        // Set next invoice number automatically
        function setNextInvoiceNumber(invoices) {
            const numInput = document.querySelector('[name="invoice_number"]');
            if (!numInput.value || numInput.value === '') {
                const maxNum = invoices.length > 0 
                    ? Math.max(...invoices.map(inv => parseInt(inv.invoice_num) || 0))
                    : 0;
                numInput.value = maxNum + 1;
            }
        }

        // Render invoices list
        function renderInvoicesList(invoices) {
            const tbody = document.getElementById('invoices-list');
            
            if (invoices.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-4">ğŸ“­ NÄ—ra iÅ¡saugotÅ³ sÄ…skaitÅ³</td></tr>';
                return;
            }

            // Sort by date descending
            invoices.sort((a, b) => new Date(b.date) - new Date(a.date));

            tbody.innerHTML = invoices.map(inv => {
                // Determine payment status styling
                let statusClass = 'status-pending';
                let statusText = 'â³ Laukia';
                
                if (inv.payment_status === 'paid') {
                    statusClass = 'status-paid';
                    statusText = 'âœ… ApmokÄ—ta';
                } else if (inv.due_date) {
                    const dueDate = new Date(inv.due_date);
                    if (dueDate < new Date()) {
                        statusClass = 'status-overdue';
                        statusText = 'âŒ VÄ—luoja';
                    }
                }
                
                return `
                <tr class="invoice-row" onclick="window.viewInvoice('${inv.id}')">
                    <td><strong>${inv.invoice_series || 'SF'}-${inv.invoice_num || '-'}</strong></td>
                    <td>${inv.client_name || '-'}</td>
                    <td>${inv.date || '-'}</td>
                    <td class="text-end"><strong>${(inv.total || 0).toFixed(2)} â‚¬</strong></td>
                    <td class="text-center">
                        <span class="badge ${statusClass}" style="cursor:pointer;" onclick="event.stopPropagation(); window.showPaymentModal('${inv.id}')">${statusText}</span>
                    </td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="event.stopPropagation(); window.editInvoice('${inv.id}')" title="Redaguoti">âœï¸</button>
                        <button class="btn btn-sm btn-outline-success me-1" onclick="event.stopPropagation(); window.downloadInvoicePdf('${inv.id}')" title="PDF">ğŸ“„</button>
                        <button class="btn btn-sm btn-outline-danger" onclick="event.stopPropagation(); window.deleteInvoice('${inv.id}')" title="Trinti">ğŸ—‘ï¸</button>
                    </td>
                </tr>
            `}).join('');
        }

        // Update statistics
        function updateStatistics(invoices) {
            const totalCount = invoices.length;
            const paidInvoices = invoices.filter(inv => inv.payment_status === 'paid');
            const unpaidInvoices = invoices.filter(inv => inv.payment_status !== 'paid');
            
            const paidAmount = paidInvoices.reduce((sum, inv) => sum + (inv.total || 0), 0);
            const unpaidAmount = unpaidInvoices.reduce((sum, inv) => sum + (inv.total || 0), 0);
            
            // This month
            const now = new Date();
            const thisMonthInvoices = invoices.filter(inv => {
                const invDate = new Date(inv.date);
                return invDate.getMonth() === now.getMonth() && invDate.getFullYear() === now.getFullYear();
            });
            const thisMonthAmount = thisMonthInvoices.reduce((sum, inv) => sum + (inv.total || 0), 0);

            document.getElementById('stat-total-count').textContent = totalCount;
            document.getElementById('stat-paid-amount').textContent = paidAmount.toFixed(2) + ' â‚¬';
            document.getElementById('stat-unpaid-amount').textContent = unpaidAmount.toFixed(2) + ' â‚¬';
            document.getElementById('stat-this-month').textContent = thisMonthAmount.toFixed(2) + ' â‚¬';
        }

        // Save invoice
        window.saveInvoice = async function() {
            if (!window.currentUser || !window.currentUser.id) {
                alert('Klaida: Vartotojas neprisijungÄ™s!');
                return;
            }
            
            const form = document.getElementById('invoice-form');
            const itemsBody = document.getElementById('items-body');
            const items = [];
            itemsBody.querySelectorAll('tr').forEach(row => {
                const desc = row.querySelector('[name="item_description"]')?.value.trim();
                const qty = parseFloat(row.querySelector('[name="item_qty"]')?.value) || 0;
                const net = parseFloat(row.querySelector('[name="item_net"]')?.value) || 0;
                const vatRate = parseFloat(row.querySelector('[name="item_vat_rate"]')?.value) || 21;
                const total = parseFloat(row.querySelector('[name="item_total"]')?.value) || 0;
                if (desc && qty > 0) {
                    items.push({ description: desc, qty, net, vatRate, vatAmount: net * qty * vatRate / 100, total });
                }
            });

            const invoiceData = {
                invoice_title: form.querySelector('[name="invoice_title"]').value.trim() || 'PVM SÄ„SKAITA FAKTÅªRA',
                // PardavÄ—jo duomenys
                seller_name: form.querySelector('[name="seller_name"]')?.value.trim() || '',
                seller_code: form.querySelector('[name="seller_code"]')?.value.trim() || '',
                seller_vat: form.querySelector('[name="seller_vat"]')?.value.trim() || '',
                seller_bank: form.querySelector('[name="seller_bank"]')?.value.trim() || '',
                seller_address: form.querySelector('[name="seller_address"]')?.value.trim() || '',
                // PirkÄ—jo duomenys
                client_name: form.querySelector('[name="client_name"]').value.trim(),
                client_code: form.querySelector('[name="client_code"]')?.value.trim() || '',
                client_vat: form.querySelector('[name="client_vat"]')?.value.trim() || '',
                client_address: form.querySelector('[name="client_address"]')?.value.trim() || '',
                // SÄ…skaitos duomenys
                invoice_series: form.querySelector('[name="invoice_series"]').value.trim() || 'SF',
                invoice_num: parseInt(form.querySelector('[name="invoice_number"]').value) || 1,
                date: form.querySelector('[name="date"]').value,
                due_date: form.querySelector('[name="due_date"]').value || '',
                items: items,
                subtotal: parseFloat(document.getElementById('subtotal').textContent) || 0,
                vat_total: parseFloat(document.getElementById('vat-total').textContent) || 0,
                total: parseFloat(document.getElementById('invoice-total').textContent) || 0
            };

            if (!invoiceData.client_name || !invoiceData.invoice_num || !invoiceData.date) {
                alert('UÅ¾pildykite visus laukus!');
                return;
            }
            
            if (items.length === 0) {
                alert('PridÄ—kite bent vienÄ… prekÄ™/paslaugÄ…!');
                return;
            }

            const btn = document.getElementById('save-invoice-btn');
            btn.disabled = true;
            btn.innerHTML = 'â³ Saugoma...';

            try {
                const editingId = document.getElementById('editing-invoice-id').value;
                const invoiceId = editingId || window.id();

                const existingInvoice = window.allInvoices?.find(i => i.id === editingId);

                await window.db.transact([
                    window.tx.invoices[invoiceId].update({
                        ...invoiceData,
                        payment_status: existingInvoice?.payment_status || 'unpaid',
                        payment_date: existingInvoice?.payment_date || null,
                        userId: window.currentUser.id,
                        updatedAt: new Date().toISOString()
                    })
                ]);

                alert('âœ… SÄ…skaita iÅ¡saugota!');
                window.clearInvoiceForm();
            } catch (e) {
                console.error('Save error:', e);
                alert('Klaida saugant: ' + (e.message || 'neÅ¾inoma klaida'));
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'ğŸ’¾ IÅ¡saugoti sÄ…skaitÄ…';
            }
        };

        // View invoice in modal
        window.viewInvoice = function(invoiceId) {
            const invoice = window.allInvoices?.find(i => i.id === invoiceId);
            if (!invoice) return;

            document.getElementById('modal-invoice-title').textContent = invoice.invoice_title || 'SÄ…skaita';
            document.getElementById('modal-invoice-number').textContent = `${invoice.invoice_series || 'SF'}-${invoice.invoice_num}`;
            
            let itemsHtml = '';
            (invoice.items || []).forEach(item => {
                itemsHtml += `<tr>
                    <td>${item.description}</td>
                    <td class="text-center">${item.qty}</td>
                    <td class="text-end">${(item.net || 0).toFixed(2)} â‚¬</td>
                    <td class="text-center">${item.vatRate || 21}%</td>
                    <td class="text-end"><strong>${(item.total || 0).toFixed(2)} â‚¬</strong></td>
                </tr>`;
            });

            // PardavÄ—jo info
            let sellerInfo = '';
            if (invoice.seller_name) {
                sellerInfo = `
                    <div class="col-md-6 mb-3">
                        <div class="card bg-light">
                            <div class="card-body py-2">
                                <h6 class="card-title mb-1">ğŸ¢ PardavÄ—jas</h6>
                                <strong>${invoice.seller_name}</strong><br>
                                ${invoice.seller_code ? `Ä®m. kodas: ${invoice.seller_code}<br>` : ''}
                                ${invoice.seller_vat ? `PVM kodas: ${invoice.seller_vat}<br>` : ''}
                                ${invoice.seller_bank ? `IBAN: ${invoice.seller_bank}<br>` : ''}
                                ${invoice.seller_address ? `${invoice.seller_address}` : ''}
                            </div>
                        </div>
                    </div>`;
            }

            // PirkÄ—jo info
            let buyerInfo = `
                <div class="col-md-6 mb-3">
                    <div class="card bg-light">
                        <div class="card-body py-2">
                            <h6 class="card-title mb-1">ğŸ‘¤ PirkÄ—jas</h6>
                            <strong>${invoice.client_name}</strong><br>
                            ${invoice.client_code ? `Ä®m. kodas: ${invoice.client_code}<br>` : ''}
                            ${invoice.client_vat ? `PVM kodas: ${invoice.client_vat}<br>` : ''}
                            ${invoice.client_address ? `${invoice.client_address}` : ''}
                        </div>
                    </div>
                </div>`;

            // Payment status
            let paymentInfo = '';
            if (invoice.payment_status === 'paid') {
                paymentInfo = `<span class="badge bg-success">âœ… ApmokÄ—ta${invoice.payment_date ? ': ' + invoice.payment_date : ''}</span>`;
            } else {
                paymentInfo = `<span class="badge bg-warning text-dark">â³ NeapmokÄ—ta</span>`;
            }

            document.getElementById('modal-invoice-body').innerHTML = `
                <div class="row mb-2">
                    <div class="col-md-4">
                        <strong>Data:</strong> ${invoice.date}
                    </div>
                    <div class="col-md-4">
                        <strong>Terminas:</strong> ${invoice.due_date || '-'}
                    </div>
                    <div class="col-md-4 text-end">
                        ${paymentInfo}
                    </div>
                </div>
                <div class="row">
                    ${sellerInfo}
                    ${buyerInfo}
                </div>
                <table class="table table-bordered">
                    <thead class="table-light">
                        <tr>
                            <th>ApraÅ¡ymas</th>
                            <th class="text-center">Kiekis</th>
                            <th class="text-end">Kaina</th>
                            <th class="text-center">PVM</th>
                            <th class="text-end">Suma</th>
                        </tr>
                    </thead>
                    <tbody>${itemsHtml}</tbody>
                </table>
                <div class="text-end">
                    <p>Be PVM: <strong>${(invoice.subtotal || 0).toFixed(2)} â‚¬</strong></p>
                    <p>PVM: <strong>${(invoice.vat_total || 0).toFixed(2)} â‚¬</strong></p>
                    <h5>VISO: <strong>${(invoice.total || 0).toFixed(2)} â‚¬</strong></h5>
                </div>
            `;

            document.getElementById('modal-download-pdf').onclick = () => window.downloadInvoicePdf(invoiceId);
            
            new bootstrap.Modal(document.getElementById('viewInvoiceModal')).show();
        };

        // Edit invoice
        window.editInvoice = function(invoiceId) {
            const invoice = window.allInvoices?.find(i => i.id === invoiceId);
            if (!invoice) return;
            window.loadInvoiceToForm(invoice);
        };

        // Download PDF
        window.downloadInvoicePdf = async function(invoiceId) {
            const invoice = window.allInvoices?.find(i => i.id === invoiceId);
            if (!invoice) return;
            
            // Convert to format expected by generatePDF
            const pdfData = {
                invoice_title: invoice.invoice_title || 'PVM SÄ„SKAITA FAKTÅªRA',
                invoice_series: invoice.invoice_series || 'SF',
                invoice_number: invoice.invoice_num,
                date: invoice.date,
                due_date: invoice.due_date,
                seller_name: invoice.seller_name,
                seller_code: invoice.seller_code,
                seller_vat: invoice.seller_vat,
                seller_bank: invoice.seller_bank,
                seller_address: invoice.seller_address,
                client_name: invoice.client_name,
                client_code: invoice.client_code,
                client_vat: invoice.client_vat,
                client_address: invoice.client_address,
                items: invoice.items,
                subtotal: invoice.subtotal,
                vat_total: invoice.vat_total,
                total: invoice.total
            };
            
            await window.generatePDF(pdfData);
        };

        // Delete invoice
        window.deleteInvoice = async function(invoiceId) {
            if (!confirm('Ar tikrai norite iÅ¡trinti Å¡iÄ… sÄ…skaitÄ…?')) return;
            
            try {
                await window.db.transact([window.tx.invoices[invoiceId].delete()]);
                alert('âœ… SÄ…skaita iÅ¡trinta!');
            } catch (e) {
                console.error('Delete error:', e);
                alert('Klaida: ' + e.message);
            }
        };

        // Sign out
        window.signOut = function() {
            if (db?.auth) {
                db.auth.signOut().then(() => {
                    localStorage.removeItem('currentUser');
                    window.location.href = '/';
                });
            }
        };

        // Get invoice data from form
        window.getInvoiceData = function() {
            const form = document.getElementById('invoice-form');
            const itemsBody = document.getElementById('items-body');
            const items = [];
            itemsBody.querySelectorAll('tr').forEach(row => {
                const desc = row.querySelector('[name="item_description"]')?.value.trim();
                const qty = parseFloat(row.querySelector('[name="item_qty"]')?.value) || 0;
                const net = parseFloat(row.querySelector('[name="item_net"]')?.value) || 0;
                const vatRate = parseFloat(row.querySelector('[name="item_vat_rate"]')?.value) || 21;
                const total = parseFloat(row.querySelector('[name="item_total"]')?.value) || 0;
                if (desc && qty > 0) {
                    items.push({ description: desc, qty, net, vatRate, vatAmount: net * qty * vatRate / 100, total });
                }
            });
            return {
                invoice_title: form.querySelector('[name="invoice_title"]').value.trim() || 'PVM SÄ„SKAITA FAKTÅªRA',
                invoice_series: form.querySelector('[name="invoice_series"]').value.trim() || 'SF',
                invoice_number: form.querySelector('[name="invoice_number"]').value.trim(),
                date: form.querySelector('[name="date"]').value,
                due_date: form.querySelector('[name="due_date"]').value || '',
                // PardavÄ—jo duomenys
                seller_name: form.querySelector('[name="seller_name"]')?.value.trim() || '',
                seller_code: form.querySelector('[name="seller_code"]')?.value.trim() || '',
                seller_vat: form.querySelector('[name="seller_vat"]')?.value.trim() || '',
                seller_bank: form.querySelector('[name="seller_bank"]')?.value.trim() || '',
                seller_address: form.querySelector('[name="seller_address"]')?.value.trim() || '',
                // PirkÄ—jo duomenys
                client_name: form.querySelector('[name="client_name"]').value.trim(),
                client_code: form.querySelector('[name="client_code"]')?.value.trim() || '',
                client_vat: form.querySelector('[name="client_vat"]')?.value.trim() || '',
                client_address: form.querySelector('[name="client_address"]')?.value.trim() || '',
                // Items & totals
                items: items,
                subtotal: parseFloat(document.getElementById('subtotal').textContent) || 0,
                vat_total: parseFloat(document.getElementById('vat-total').textContent) || 0,
                total: parseFloat(document.getElementById('invoice-total').textContent) || 0
            };
        };

        // Wire up save button
        document.getElementById('save-invoice-btn').addEventListener('click', window.saveInvoice);
    </script>
</body>
</html>
