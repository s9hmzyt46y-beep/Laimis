<!DOCTYPE html>
<html lang="lt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SƒÖskaitos - Mano Startuolis</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 12px; padding: 20px; text-align: center; }
        .stat-card h3 { font-size: 28px; font-weight: bold; margin: 0; }
        .stat-card p { font-size: 14px; opacity: 0.9; margin: 5px 0 0 0; }
        .stat-card.green { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
        .stat-card.orange { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .stat-card.blue { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .vat-summary { background: #f8f9fa; border-radius: 8px; padding: 15px; }
        .total-row { font-weight: bold; font-size: 1.1em; border-top: 2px solid #dee2e6; padding-top: 10px; margin-top: 10px; }
        .invoice-row { cursor: pointer; transition: background 0.2s; }
        .invoice-row:hover { background: #e3f2fd; }
        .status-paid { color: #28a745; font-weight: bold; }
        .status-pending { color: #ffc107; font-weight: bold; }
        .status-overdue { color: #dc3545; font-weight: bold; }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4">
        <div class="container">
            <a class="navbar-brand" href="/dashboard">üöÄ Mano Startuolis</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNavbar">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="mainNavbar">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item"><a class="nav-link" href="/expenses">I≈°laidos</a></li>
                    <li class="nav-item"><a class="nav-link active" href="/invoices">SƒÖskaitos</a></li>
                    <li class="nav-item"><a class="nav-link" href="/clients">Klientai</a></li>
                </ul>
                <div class="d-flex align-items-center">
                    <span class="text-muted me-3" id="navbar-user"></span>
                    <button class="btn btn-outline-secondary btn-sm" onclick="window.signOut()">üö™ Atsijungti</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="stat-card">
                    <h3 id="stat-total-count">0</h3>
                    <p>üìÑ Visos sƒÖskaitos</p>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stat-card green">
                    <h3 id="stat-total-amount">0 ‚Ç¨</h3>
                    <p>üí∞ Bendra suma</p>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stat-card orange">
                    <h3 id="stat-this-month">0 ‚Ç¨</h3>
                    <p>üìÖ ≈†ƒØ mƒónesƒØ</p>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stat-card blue">
                    <h3 id="stat-avg">0 ‚Ç¨</h3>
                    <p>üìä Vidutinƒó sƒÖskaita</p>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Left: New Invoice Form -->
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">‚ûï Nauja sƒÖskaita fakt≈´ra</h5>
                        <button type="button" class="btn btn-sm btn-light" onclick="clearInvoiceForm()">üîÑ I≈°valyti</button>
                    </div>
                    <div class="card-body">
                        <form id="invoice-form">
                            <input type="hidden" id="editing-invoice-id" value="">
                            
                            <!-- Pardavƒójo duomenys -->
                            <div class="card bg-light mb-3">
                                <div class="card-header py-2">
                                    <strong>üè¢ Pardavƒójo duomenys</strong>
                                    <button type="button" class="btn btn-sm btn-link float-end" data-bs-toggle="collapse" data-bs-target="#sellerDetails">
                                        ‚ñº Rodyti/Slƒópti
                                    </button>
                                </div>
                                <div class="collapse show" id="sellerDetails">
                                    <div class="card-body py-2">
                                        <div class="row g-2">
                                            <div class="col-md-6">
                                                <input type="text" class="form-control form-control-sm" name="seller_name" placeholder="ƒÆmonƒós pavadinimas" value="">
                                            </div>
                                            <div class="col-md-6">
                                                <input type="text" class="form-control form-control-sm" name="seller_code" placeholder="ƒÆmonƒós kodas">
                                            </div>
                                            <div class="col-md-6">
                                                <input type="text" class="form-control form-control-sm" name="seller_vat" placeholder="PVM mokƒótojo kodas">
                                            </div>
                                            <div class="col-md-6">
                                                <input type="text" class="form-control form-control-sm" name="seller_bank" placeholder="Banko sƒÖskaita (IBAN)">
                                            </div>
                                            <div class="col-12">
                                                <input type="text" class="form-control form-control-sm" name="seller_address" placeholder="Adresas">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Pirkƒójo ir sƒÖskaitos duomenys -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">üë§ Pirkƒójas</label>
                                    <select id="clientSelect" class="form-select mb-2">
                                        <option value="">--- Pasirinkti ---</option>
                                    </select>
                                    <input type="text" class="form-control" name="client_name" placeholder="Kliento pavadinimas" required>
                                    <input type="text" class="form-control form-control-sm mt-1" name="client_code" placeholder="ƒÆmonƒós kodas">
                                    <input type="text" class="form-control form-control-sm mt-1" name="client_vat" placeholder="PVM kodas">
                                    <input type="text" class="form-control form-control-sm mt-1" name="client_address" placeholder="Adresas">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">üìÑ SƒÖskaitos Nr.</label>
                                    <input type="text" class="form-control" name="invoice_number" placeholder="SF-001" required>
                                    <label class="form-label mt-2">üìÖ Data</label>
                                    <input type="date" class="form-control" name="date" required>
                                </div>
                            </div>

                            <!-- Items Table -->
                            <div class="table-responsive mb-3">
                                <table class="table table-sm table-bordered" id="items-table">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Apra≈°ymas</th>
                                            <th style="width:60px;">Kiek.</th>
                                            <th style="width:80px;">Kaina</th>
                                            <th style="width:50px;">PVM%</th>
                                            <th style="width:80px;">Suma</th>
                                            <th style="width:40px;">üóëÔ∏è</th>
                                        </tr>
                                    </thead>
                                    <tbody id="items-body"></tbody>
                                </table>
                            </div>

                            <button type="button" class="btn btn-outline-primary btn-sm mb-3" id="add-item-btn">+ Eilutƒó</button>

                            <!-- Totals -->
                            <div class="vat-summary">
                                <div class="row">
                                    <div class="col-7">Be PVM:</div>
                                    <div class="col-5 text-end"><span id="subtotal">0.00</span> ‚Ç¨</div>
                                </div>
                                <div class="row">
                                    <div class="col-7">PVM:</div>
                                    <div class="col-5 text-end"><span id="vat-total">0.00</span> ‚Ç¨</div>
                                </div>
                                <div class="row total-row">
                                    <div class="col-7">VISO:</div>
                                    <div class="col-5 text-end"><span id="invoice-total">0.00</span> ‚Ç¨</div>
                                </div>
                            </div>

                            <div class="d-flex gap-2 mt-3">
                                <button type="button" class="btn btn-success flex-grow-1" id="save-invoice-btn">
                                    üíæ I≈°saugoti sƒÖskaitƒÖ
                                </button>
                                <button type="button" class="btn btn-primary" id="generate-pdf-btn">
                                    üìÑ PDF
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Right: Saved Invoices List -->
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0">üìã I≈°saugotos sƒÖskaitos</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Nr.</th>
                                        <th>Klientas</th>
                                        <th>Data</th>
                                        <th class="text-end">Suma</th>
                                        <th class="text-center">Veiksmai</th>
                                    </tr>
                                </thead>
                                <tbody id="invoices-list">
                                    <tr>
                                        <td colspan="5" class="text-center text-muted py-4">
                                            ‚è≥ Kraunama...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- View Invoice Modal -->
    <div class="modal fade" id="viewInvoiceModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">üìÑ SƒÖskaita <span id="modal-invoice-number"></span></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modal-invoice-body">
                    <!-- Content loaded dynamically -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">U≈ædaryti</button>
                    <button type="button" class="btn btn-primary" id="modal-download-pdf">üìÑ Atsisi≈≥sti PDF</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // DOM Elements
        const itemsBody = document.getElementById('items-body');
        const subtotalEl = document.getElementById('subtotal');
        const vatTotalEl = document.getElementById('vat-total');
        const invoiceTotalEl = document.getElementById('invoice-total');

        // Recalculate totals
        function recalcTotals() {
            let subtotal = 0, vatTotal = 0, total = 0;
            itemsBody.querySelectorAll('tr').forEach(row => {
                const qty = parseFloat(row.querySelector('[name="item_qty"]')?.value) || 0;
                const net = parseFloat(row.querySelector('[name="item_net"]')?.value) || 0;
                const vatRate = parseFloat(row.querySelector('[name="item_vat_rate"]')?.value) || 21;
                const lineNet = qty * net;
                const lineVat = lineNet * (vatRate / 100);
                subtotal += lineNet;
                vatTotal += lineVat;
                total += lineNet + lineVat;
                
                const totalInput = row.querySelector('[name="item_total"]');
                if (totalInput) totalInput.value = (lineNet + lineVat).toFixed(2);
            });
            subtotalEl.textContent = subtotal.toFixed(2);
            vatTotalEl.textContent = vatTotal.toFixed(2);
            invoiceTotalEl.textContent = total.toFixed(2);
        }

        // Add item row
        function addItem(data = {}) {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><input type="text" class="form-control form-control-sm" name="item_description" value="${data.description || ''}" required></td>
                <td><input type="number" class="form-control form-control-sm" name="item_qty" min="1" value="${data.qty || 1}" required></td>
                <td><input type="number" class="form-control form-control-sm" name="item_net" min="0" step="0.01" value="${data.net || '0.00'}" required></td>
                <td><input type="number" class="form-control form-control-sm" name="item_vat_rate" min="0" max="100" value="${data.vatRate || 21}" required></td>
                <td><input type="number" class="form-control form-control-sm" name="item_total" value="${data.total || '0.00'}" readonly style="background:#e9ecef;"></td>
                <td class="text-center"><button type="button" class="btn btn-sm btn-outline-danger remove-btn">‚úï</button></td>
            `;
            itemsBody.appendChild(row);
            
            row.querySelectorAll('input').forEach(input => {
                if (input.name !== 'item_total') {
                    input.addEventListener('input', recalcTotals);
                }
            });
            row.querySelector('.remove-btn').addEventListener('click', () => { row.remove(); recalcTotals(); });
            recalcTotals();
        }

        document.getElementById('add-item-btn').addEventListener('click', () => addItem());
        addItem(); // Initial row

        // Clear form
        window.clearInvoiceForm = function() {
            document.getElementById('invoice-form').reset();
            document.getElementById('editing-invoice-id').value = '';
            itemsBody.innerHTML = '';
            addItem();
            document.getElementById('save-invoice-btn').innerHTML = 'üíæ I≈°saugoti sƒÖskaitƒÖ';
        };

        // Get form data
        function getInvoiceData() {
            const form = document.getElementById('invoice-form');
            const items = [];
            itemsBody.querySelectorAll('tr').forEach(row => {
                const desc = row.querySelector('[name="item_description"]').value.trim();
                const qty = parseFloat(row.querySelector('[name="item_qty"]').value) || 0;
                const net = parseFloat(row.querySelector('[name="item_net"]').value) || 0;
                const vatRate = parseFloat(row.querySelector('[name="item_vat_rate"]').value) || 21;
                const total = parseFloat(row.querySelector('[name="item_total"]').value) || 0;
                if (desc && qty > 0) {
                    items.push({ description: desc, qty, net, vatRate, vatAmount: net * qty * vatRate / 100, total });
                }
            });
            
            return {
                client_name: form.querySelector('[name="client_name"]').value.trim(),
                invoice_number: form.querySelector('[name="invoice_number"]').value.trim(),
                date: form.querySelector('[name="date"]').value,
                items: items,
                subtotal: parseFloat(subtotalEl.textContent) || 0,
                vat_total: parseFloat(vatTotalEl.textContent) || 0,
                total: parseFloat(invoiceTotalEl.textContent) || 0
            };
        }

        // Load invoice into form for editing
        window.loadInvoiceToForm = function(invoice) {
            const form = document.getElementById('invoice-form');
            
            // Pardavƒójo duomenys
            if (form.querySelector('[name="seller_name"]')) form.querySelector('[name="seller_name"]').value = invoice.seller_name || '';
            if (form.querySelector('[name="seller_code"]')) form.querySelector('[name="seller_code"]').value = invoice.seller_code || '';
            if (form.querySelector('[name="seller_vat"]')) form.querySelector('[name="seller_vat"]').value = invoice.seller_vat || '';
            if (form.querySelector('[name="seller_bank"]')) form.querySelector('[name="seller_bank"]').value = invoice.seller_bank || '';
            if (form.querySelector('[name="seller_address"]')) form.querySelector('[name="seller_address"]').value = invoice.seller_address || '';
            
            // Pirkƒójo duomenys
            form.querySelector('[name="client_name"]').value = invoice.client_name || '';
            if (form.querySelector('[name="client_code"]')) form.querySelector('[name="client_code"]').value = invoice.client_code || '';
            if (form.querySelector('[name="client_vat"]')) form.querySelector('[name="client_vat"]').value = invoice.client_vat || '';
            if (form.querySelector('[name="client_address"]')) form.querySelector('[name="client_address"]').value = invoice.client_address || '';
            
            // SƒÖskaitos duomenys
            form.querySelector('[name="invoice_number"]').value = invoice.invoice_number || '';
            form.querySelector('[name="date"]').value = invoice.date || '';
            document.getElementById('editing-invoice-id').value = invoice.id || '';
            
            itemsBody.innerHTML = '';
            const items = invoice.items || [];
            if (items.length === 0) {
                addItem();
            } else {
                items.forEach(item => addItem(item));
            }
            
            document.getElementById('save-invoice-btn').innerHTML = 'üíæ Atnaujinti sƒÖskaitƒÖ';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        // Generate PDF - exposed globally
        window.generatePDF = async function(invoiceData = null) {
            const data = invoiceData || getInvoiceData();
            
            if (!data.client_name || !data.invoice_number || !data.date) {
                alert('U≈æpildykite visus laukus!');
                return;
            }
            if (data.items.length === 0) {
                alert('Pridƒókite bent vienƒÖ eilutƒô!');
                return;
            }

            const btn = document.getElementById('generate-pdf-btn');
            btn.disabled = true;
            btn.innerHTML = '‚è≥...';

            try {
                const response = await fetch('/api/generate-pdf', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || 'PDF klaida');
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${data.invoice_number}.pdf`;
                a.click();
                window.URL.revokeObjectURL(url);
            } catch (error) {
                alert('Klaida: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'üìÑ PDF';
            }
        }

        document.getElementById('generate-pdf-btn').addEventListener('click', () => window.generatePDF());
    </script>

    <!-- InstantDB integration -->
    <script type="module">
        import { init, tx, id } from 'https://esm.sh/@instantdb/core';

        const APP_ID = 'ad4539a9-2114-44bb-a2f4-524d57448deb';
        let db, currentUserId;

        try {
            db = init({ appId: APP_ID });
            window.db = db;
            window.tx = tx;
            window.id = id;
            console.log("‚úÖ InstantDB connected");
        } catch (e) {
            console.error("DB error:", e);
        }

        if (db) {
            db.subscribeAuth((auth) => {
                if (!auth.user) {
                    window.location.href = '/';
                } else {
                    window.currentUser = auth.user;
                    currentUserId = auth.user.id;
                    document.getElementById('navbar-user').textContent = 'üë§ ' + auth.user.email;
                    loadClients(auth.user.id);
                    loadInvoices(auth.user.id);
                }
            });
        }

        // Load clients for dropdown
        function loadClients(userId) {
            db.subscribeQuery({ clients: { $: { where: { userId: userId } } } }, (resp) => {
                if (resp.error) return;
                const clients = resp.data.clients || [];
                const select = document.getElementById('clientSelect');
                select.innerHTML = '<option value="">--- Pasirinkti ---</option>';
                clients.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.id;
                    opt.textContent = c.name || '(be pavadinimo)';
                    select.appendChild(opt);
                });
                select.onchange = () => {
                    const client = clients.find(c => c.id === select.value);
                    if (client) document.querySelector('[name="client_name"]').value = client.name || '';
                };
            });
        }

        // Load invoices
        function loadInvoices(userId) {
            db.subscribeQuery({ invoices: { $: { where: { userId: userId } } } }, (resp) => {
                if (resp.error) {
                    console.error("Load invoices error:", resp.error);
                    return;
                }
                const invoices = resp.data.invoices || [];
                renderInvoicesList(invoices);
                updateStatistics(invoices);
            });
        }

        // Render invoices list
        function renderInvoicesList(invoices) {
            const tbody = document.getElementById('invoices-list');
            
            if (invoices.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4">üì≠ Nƒóra i≈°saugot≈≥ sƒÖskait≈≥</td></tr>';
                return;
            }

            // Sort by date descending
            invoices.sort((a, b) => new Date(b.date) - new Date(a.date));

            tbody.innerHTML = invoices.map(inv => `
                <tr class="invoice-row" onclick="window.viewInvoice('${inv.id}')">
                    <td><strong>${inv.invoice_number || '-'}</strong></td>
                    <td>${inv.client_name || '-'}</td>
                    <td>${inv.date || '-'}</td>
                    <td class="text-end"><strong>${(inv.total || 0).toFixed(2)} ‚Ç¨</strong></td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="event.stopPropagation(); window.editInvoice('${inv.id}')" title="Redaguoti">‚úèÔ∏è</button>
                        <button class="btn btn-sm btn-outline-success me-1" onclick="event.stopPropagation(); window.downloadInvoicePdf('${inv.id}')" title="PDF">üìÑ</button>
                        <button class="btn btn-sm btn-outline-danger" onclick="event.stopPropagation(); window.deleteInvoice('${inv.id}')" title="Trinti">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');

            // Store invoices for later access
            window.allInvoices = invoices;
        }

        // Update statistics
        function updateStatistics(invoices) {
            const totalCount = invoices.length;
            const totalAmount = invoices.reduce((sum, inv) => sum + (inv.total || 0), 0);
            
            // This month
            const now = new Date();
            const thisMonthInvoices = invoices.filter(inv => {
                const invDate = new Date(inv.date);
                return invDate.getMonth() === now.getMonth() && invDate.getFullYear() === now.getFullYear();
            });
            const thisMonthAmount = thisMonthInvoices.reduce((sum, inv) => sum + (inv.total || 0), 0);
            
            const avgAmount = totalCount > 0 ? totalAmount / totalCount : 0;

            document.getElementById('stat-total-count').textContent = totalCount;
            document.getElementById('stat-total-amount').textContent = totalAmount.toFixed(2) + ' ‚Ç¨';
            document.getElementById('stat-this-month').textContent = thisMonthAmount.toFixed(2) + ' ‚Ç¨';
            document.getElementById('stat-avg').textContent = avgAmount.toFixed(2) + ' ‚Ç¨';
        }

        // Save invoice
        window.saveInvoice = async function() {
            // Check if user is logged in
            if (!window.currentUser || !window.currentUser.id) {
                alert('Klaida: Vartotojas neprisijungƒôs!');
                return;
            }
            
            // Get form data directly
            const form = document.getElementById('invoice-form');
            const itemsBody = document.getElementById('items-body');
            const items = [];
            itemsBody.querySelectorAll('tr').forEach(row => {
                const desc = row.querySelector('[name="item_description"]')?.value.trim();
                const qty = parseFloat(row.querySelector('[name="item_qty"]')?.value) || 0;
                const net = parseFloat(row.querySelector('[name="item_net"]')?.value) || 0;
                const vatRate = parseFloat(row.querySelector('[name="item_vat_rate"]')?.value) || 21;
                const total = parseFloat(row.querySelector('[name="item_total"]')?.value) || 0;
                if (desc && qty > 0) {
                    items.push({ description: desc, qty, net, vatRate, vatAmount: net * qty * vatRate / 100, total });
                }
            });

            const invoiceData = {
                // Pardavƒójo duomenys
                seller_name: form.querySelector('[name="seller_name"]')?.value.trim() || '',
                seller_code: form.querySelector('[name="seller_code"]')?.value.trim() || '',
                seller_vat: form.querySelector('[name="seller_vat"]')?.value.trim() || '',
                seller_bank: form.querySelector('[name="seller_bank"]')?.value.trim() || '',
                seller_address: form.querySelector('[name="seller_address"]')?.value.trim() || '',
                // Pirkƒójo duomenys
                client_name: form.querySelector('[name="client_name"]').value.trim(),
                client_code: form.querySelector('[name="client_code"]')?.value.trim() || '',
                client_vat: form.querySelector('[name="client_vat"]')?.value.trim() || '',
                client_address: form.querySelector('[name="client_address"]')?.value.trim() || '',
                // SƒÖskaitos duomenys
                invoice_number: form.querySelector('[name="invoice_number"]').value.trim(),
                date: form.querySelector('[name="date"]').value,
                items: items,
                subtotal: parseFloat(document.getElementById('subtotal').textContent) || 0,
                vat_total: parseFloat(document.getElementById('vat-total').textContent) || 0,
                total: parseFloat(document.getElementById('invoice-total').textContent) || 0
            };

            if (!invoiceData.client_name || !invoiceData.invoice_number || !invoiceData.date) {
                alert('U≈æpildykite visus laukus!');
                return;
            }
            
            if (items.length === 0) {
                alert('Pridƒókite bent vienƒÖ prekƒô/paslaugƒÖ!');
                return;
            }

            const btn = document.getElementById('save-invoice-btn');
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Saugoma...';

            try {
                const editingId = document.getElementById('editing-invoice-id').value;
                const invoiceId = editingId || window.id();

                console.log('Saving invoice:', invoiceId, invoiceData);

                await window.db.transact([
                    window.tx.invoices[invoiceId].update({
                        ...invoiceData,
                        userId: window.currentUser.id,
                        updatedAt: new Date().toISOString()
                    })
                ]);

                alert('‚úÖ SƒÖskaita i≈°saugota!');
                window.clearInvoiceForm();
            } catch (e) {
                console.error('Save error:', e);
                alert('Klaida saugant: ' + (e.message || 'ne≈æinoma klaida'));
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'üíæ I≈°saugoti sƒÖskaitƒÖ';
            }
        };

        // View invoice in modal
        window.viewInvoice = function(invoiceId) {
            const invoice = window.allInvoices?.find(i => i.id === invoiceId);
            if (!invoice) return;

            document.getElementById('modal-invoice-number').textContent = invoice.invoice_number;
            
            let itemsHtml = '';
            (invoice.items || []).forEach(item => {
                itemsHtml += `<tr>
                    <td>${item.description}</td>
                    <td class="text-center">${item.qty}</td>
                    <td class="text-end">${(item.net || 0).toFixed(2)} ‚Ç¨</td>
                    <td class="text-center">${item.vatRate || 21}%</td>
                    <td class="text-end"><strong>${(item.total || 0).toFixed(2)} ‚Ç¨</strong></td>
                </tr>`;
            });

            // Pardavƒójo info
            let sellerInfo = '';
            if (invoice.seller_name) {
                sellerInfo = `
                    <div class="col-md-6 mb-3">
                        <div class="card bg-light">
                            <div class="card-body py-2">
                                <h6 class="card-title mb-1">üè¢ Pardavƒójas</h6>
                                <strong>${invoice.seller_name}</strong><br>
                                ${invoice.seller_code ? `ƒÆm. kodas: ${invoice.seller_code}<br>` : ''}
                                ${invoice.seller_vat ? `PVM kodas: ${invoice.seller_vat}<br>` : ''}
                                ${invoice.seller_bank ? `IBAN: ${invoice.seller_bank}<br>` : ''}
                                ${invoice.seller_address ? `${invoice.seller_address}` : ''}
                            </div>
                        </div>
                    </div>`;
            }

            // Pirkƒójo info
            let buyerInfo = `
                <div class="col-md-6 mb-3">
                    <div class="card bg-light">
                        <div class="card-body py-2">
                            <h6 class="card-title mb-1">üë§ Pirkƒójas</h6>
                            <strong>${invoice.client_name}</strong><br>
                            ${invoice.client_code ? `ƒÆm. kodas: ${invoice.client_code}<br>` : ''}
                            ${invoice.client_vat ? `PVM kodas: ${invoice.client_vat}<br>` : ''}
                            ${invoice.client_address ? `${invoice.client_address}` : ''}
                        </div>
                    </div>
                </div>`;

            document.getElementById('modal-invoice-body').innerHTML = `
                <div class="row mb-2">
                    <div class="col-md-6">
                        <strong>SƒÖskaitos Nr.:</strong> ${invoice.invoice_number}
                    </div>
                    <div class="col-md-6 text-end">
                        <strong>Data:</strong> ${invoice.date}
                    </div>
                </div>
                <div class="row">
                    ${sellerInfo}
                    ${buyerInfo}
                </div>
                <table class="table table-bordered">
                    <thead class="table-light">
                        <tr>
                            <th>Apra≈°ymas</th>
                            <th class="text-center">Kiekis</th>
                            <th class="text-end">Kaina</th>
                            <th class="text-center">PVM</th>
                            <th class="text-end">Suma</th>
                        </tr>
                    </thead>
                    <tbody>${itemsHtml}</tbody>
                </table>
                <div class="text-end">
                    <p>Be PVM: <strong>${(invoice.subtotal || 0).toFixed(2)} ‚Ç¨</strong></p>
                    <p>PVM: <strong>${(invoice.vat_total || 0).toFixed(2)} ‚Ç¨</strong></p>
                    <h5>VISO: <strong>${(invoice.total || 0).toFixed(2)} ‚Ç¨</strong></h5>
                </div>
            `;

            document.getElementById('modal-download-pdf').onclick = () => window.downloadInvoicePdf(invoiceId);
            
            new bootstrap.Modal(document.getElementById('viewInvoiceModal')).show();
        };

        // Edit invoice
        window.editInvoice = function(invoiceId) {
            const invoice = window.allInvoices?.find(i => i.id === invoiceId);
            if (!invoice) return;
            window.loadInvoiceToForm(invoice);
        };

        // Download PDF
        window.downloadInvoicePdf = async function(invoiceId) {
            const invoice = window.allInvoices?.find(i => i.id === invoiceId);
            if (!invoice) return;
            await window.generatePDF(invoice);
        };

        // Delete invoice
        window.deleteInvoice = async function(invoiceId) {
            if (!confirm('Ar tikrai norite i≈°trinti ≈°iƒÖ sƒÖskaitƒÖ?')) return;
            
            try {
                await window.db.transact([window.tx.invoices[invoiceId].delete()]);
                alert('‚úÖ SƒÖskaita i≈°trinta!');
            } catch (e) {
                console.error('Delete error:', e);
                alert('Klaida: ' + e.message);
            }
        };

        // Sign out
        window.signOut = function() {
            if (db?.auth) {
                db.auth.signOut().then(() => {
                    localStorage.removeItem('currentUser');
                    window.location.href = '/';
                });
            }
        };

        // Make getInvoiceData available
        window.getInvoiceData = function() {
            const form = document.getElementById('invoice-form');
            const itemsBody = document.getElementById('items-body');
            const items = [];
            itemsBody.querySelectorAll('tr').forEach(row => {
                const desc = row.querySelector('[name="item_description"]')?.value.trim();
                const qty = parseFloat(row.querySelector('[name="item_qty"]')?.value) || 0;
                const net = parseFloat(row.querySelector('[name="item_net"]')?.value) || 0;
                const vatRate = parseFloat(row.querySelector('[name="item_vat_rate"]')?.value) || 21;
                const total = parseFloat(row.querySelector('[name="item_total"]')?.value) || 0;
                if (desc && qty > 0) {
                    items.push({ description: desc, qty, net, vatRate, vatAmount: net * qty * vatRate / 100, total });
                }
            });
            return {
                // Pardavƒójo duomenys
                seller_name: form.querySelector('[name="seller_name"]')?.value.trim() || '',
                seller_code: form.querySelector('[name="seller_code"]')?.value.trim() || '',
                seller_vat: form.querySelector('[name="seller_vat"]')?.value.trim() || '',
                seller_bank: form.querySelector('[name="seller_bank"]')?.value.trim() || '',
                seller_address: form.querySelector('[name="seller_address"]')?.value.trim() || '',
                // Pirkƒójo duomenys
                client_name: form.querySelector('[name="client_name"]').value.trim(),
                client_code: form.querySelector('[name="client_code"]')?.value.trim() || '',
                client_vat: form.querySelector('[name="client_vat"]')?.value.trim() || '',
                client_address: form.querySelector('[name="client_address"]')?.value.trim() || '',
                // SƒÖskaitos duomenys
                invoice_number: form.querySelector('[name="invoice_number"]').value.trim(),
                date: form.querySelector('[name="date"]').value,
                items: items,
                subtotal: parseFloat(document.getElementById('subtotal').textContent) || 0,
                vat_total: parseFloat(document.getElementById('vat-total').textContent) || 0,
                total: parseFloat(document.getElementById('invoice-total').textContent) || 0
            };
        };

        // Wire up save button
        document.getElementById('save-invoice-btn').addEventListener('click', window.saveInvoice);
    </script>
</body>
</html>
